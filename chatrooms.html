<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Moonlight | Global Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #000;
            --border: rgba(255, 255, 255, 0.2);
            --panel: rgba(0, 0, 0, 0.85);
            --font-tactical: 'Syncopate', sans-serif;
            --font-main: 'Inter', sans-serif;
        }

        *{box-sizing:border-box;margin:0;padding:0}
        
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            color: #fff;
            font-family: var(--font-main);
            overflow: hidden;
        }

        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* --- MOONLIGHT HEADER --- */
        header { 
            height: 60px; 
            background: #000; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            padding: 0 25px;
            z-index: 100;
        }

        .back-btn { 
            font-family: var(--font-tactical); 
            font-size: 11px; 
            letter-spacing: 2px; 
            cursor: pointer; 
            color: #fff;
            text-decoration: none;
        }

        .main-container { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: var(--panel);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
        }

        .section-title {
            font-family: var(--font-tactical);
            color: #666;
            font-size: 8px;
            margin-top: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .sidebar-item {
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: 0.2s;
            font-family: var(--font-tactical);
            font-size: 9px;
            letter-spacing: 1px;
        }

        .sidebar-item:hover { border-color: #fff; background: rgba(255,255,255,0.05); }
        .sidebar-item.active { background: #fff; color: #000; border-color: #fff; }

        /* --- CHAT AREA --- */
        .chat-area { flex:1; display:flex; flex-direction:column; background: transparent; min-width:0; position:relative; }
        
        .chat-header {
            padding: 18px 24px;
            background: rgba(0,0,0,0.5);
            border-bottom: 1px solid var(--border);
            font-family: var(--font-tactical);
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .messages { flex:1; overflow:auto; padding:24px; display:flex; flex-direction:column; gap:14px; }
        
        .msg { max-width:65%; animation:slideIn 0.2s ease; }
        @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        
        .msg.own { align-self:flex-end; }
        
        .msg-name { font-family: var(--font-tactical); font-size: 8px; color:#888; margin-bottom:5px; display:flex; align-items:center; gap:6px; }
        .msg-name.owner { color: #fff; font-weight:700; }
        
        .owner-badge {
            background: #fff;
            color: #000;
            padding: 2px 6px;
            font-size: 7px;
            font-family: var(--font-tactical);
        }

        .msg-bubble {
            background: rgba(255,255,255,0.05);
            padding: 12px 16px;
            border: 1px solid var(--border);
            color:#fff;
            line-height:1.5;
        }

        .msg.own .msg-bubble { border-color: #fff; background: rgba(255,255,255,0.1); }
        .msg.owner-msg .msg-bubble { border: 1px solid #fff; box-shadow: 0 0 15px rgba(255,255,255,0.1); }

        /* --- INPUT BAR --- */
        .input-bar {
            display: flex;
            gap: 12px;
            padding: 20px 24px;
            background: var(--panel);
            border-top: 1px solid var(--border);
            position: relative;
        }

        .input-bar input {
            flex: 1;
            padding: 14px 18px;
            background: #000;
            border: 1px solid var(--border);
            color: #fff;
            outline: none;
            font-family: var(--font-main);
        }

        .input-bar input:focus { border-color: #fff; }

        .char-counter {
            position: absolute;
            top: -20px;
            right: 24px;
            font-size: 0.7rem;
            font-family: var(--font-tactical);
            color: #444;
        }

        .input-bar button {
            width: 100px;
            background: #fff;
            color: #000;
            font-family: var(--font-tactical);
            font-size: 10px;
            border: none;
            cursor: pointer;
            transition: 0.2s;
        }

        .input-bar button:hover { background: #ccc; }

        /* --- MODALS --- */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center; z-index:1000; }
        .modal { background:#000; border:1px solid #fff; padding:40px; min-width:360px; text-align: center; }
        .modal h2 { font-family: var(--font-tactical); font-size: 12px; letter-spacing: 3px; margin-bottom:20px; }
        .modal input { width:100%; padding:14px; background:#000; border:1px solid var(--border); color:#fff; margin-bottom:18px; outline:none; }
        .modal button { width:100%; padding:14px; background:#fff; color:#000; font-family: var(--font-tactical); font-size: 10px; border:none; cursor:pointer; }

        .warning-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff;
            color: #000;
            padding: 16px 24px;
            font-family: var(--font-tactical);
            font-size: 10px;
            z-index: 2000;
            border: 1px solid #000;
        }
    </style>
</head>
<body>

    <canvas id="starfield"></canvas>

    <header>
        <div class="back-btn" onclick="window.location.href='main.html'">M // BACK</div>
    </header>

    <div id="nameModal" class="modal-overlay">
      <div class="modal">
        <h2>INITIALIZE_ID</h2>
        <input id="nameInput" placeholder="Enter display name..." maxlength="32" autocomplete="off" />
        <button id="nameSubmit">JOIN_GLOBAL_FEED</button>
      </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
          <div class="section-title">CHANNELS</div>
          <div id="publicRoomBtn" class="sidebar-item active">üåç PUBLIC</div>
          <div id="createRoomBtn" class="sidebar-item">‚ûï CREATE ROOM</div>
          <div id="joinRoomBtn" class="sidebar-item">üîó JOIN ROOM</div>
          <div id="joinedRooms" class="sidebar-rooms" style="display:flex;flex-direction:column;gap:6px;margin-top:10px;"></div>
        </div>

        <div class="chat-area">
          <div class="chat-header" id="roomTitle">Public Chat</div>
          <div id="messages" class="messages">
            <div style="text-align:center;color:#444;font-family:'Syncopate';font-size:8px;">SECURE_CONNECTION_ESTABLISHED</div>
          </div>
          <div class="input-bar">
            <input id="msgInput" placeholder="Type a message‚Ä¶" autocomplete="off" maxlength="600" />
            <span id="charCounter" class="char-counter">0/600</span>
            <button id="sendBtn">SEND</button>
          </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('starfield');
        const ctx = canvas.getContext('2d');
        let stars = [];
        function initStars() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            stars = [];
            for (let i = 0; i < 150; i++) {
                stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 1.5, speed: Math.random() * 0.05 });
            }
        }
        function drawStars() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            stars.forEach(star => {
                ctx.beginPath(); ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2); ctx.fill();
                star.y -= star.speed; if (star.y < 0) star.y = canvas.height;
            });
            requestAnimationFrame(drawStars);
        }
        window.addEventListener('resize', initStars);
        initStars(); drawStars();
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script>
      const OWNER_IDS = ["6528690208", "3222695271", "0376780508", "0635354315"]; 
      const ID_KEY = "numericUserID";

      const banFirebaseConfig = {
        apiKey: "AIzaSyCTUq6Hye-l6Lh2ylHQ4yOM-HUWODGgMtY",
        authDomain: "chatty-boi-c876e.firebaseapp.com",
        databaseURL: "https://chatty-boi-c876e-default-rtdb.firebaseio.com",
        projectId: "chatty-boi-c876e",
        storageBucket: "chatty-boi-c876e.firebasestorage.app",
        messagingSenderId: "1073159135051",
        appId: "1:1073159135051:web:8c991df26ea3c1eb84d2ce",
        measurementId: "G-03QWMK5ZNM"
      };

      const banApp = firebase.initializeApp(banFirebaseConfig);
      const banDB = firebase.database(banApp);

      function generateNumericID() {
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        return random + timestamp;
      }

      (function() {
        'use strict';
        const originalSetItem = Storage.prototype.setItem;
        let isLocked = false;
        let myID = null;

        function lockScreen() {
          if (isLocked) return;
          isLocked = true;
          document.body.innerHTML = "";
          document.body.style.cssText = "background: red; color: white; display: flex; justify-content: center; align-items: center; font-size: 40px; height: 100vh;";
          document.body.innerText = "BANNED";
        }

        document.addEventListener("DOMContentLoaded", () => {
          myID = localStorage.getItem(ID_KEY);
          if (!myID) {
            myID = generateNumericID();
            originalSetItem.call(localStorage, ID_KEY, myID);
          }
          window.currentUserID = myID;
          window.banDatabase = banDB;

          const bannedRef = banDB.ref("bannedIDs");
          bannedRef.on("value", (snapshot) => {
            const bannedIDs = snapshot.val() || [];
            if (bannedIDs.includes(myID)) lockScreen();
          });
        });
      })();
    </script>

    <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, off, query, limitToLast } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCTUq6Hye-l6Lh2ylHQ4yOM-HUWODGgMtY",
    authDomain: "chatty-boi-c876e.firebaseapp.com",
    databaseURL: "https://chatty-boi-c876e-default-rtdb.firebaseio.com",
    projectId: "chatty-boi-c876e",
    storageBucket: "chatty-boi-c876e.firebasestorage.app",
    messagingSenderId: "1073159135051",
    appId: "1:1073159135051:web:8c991df26ea3c1eb84d2ce",
    measurementId: "G-03QWMK5ZNM"
  };

  const OWNER_IDS = ["6528690208", "4084803237", "0376780508", "0635354315", "0071913330"];
  const app = initializeApp(firebaseConfig, "chatApp");
  const db = getDatabase(app);

  const messagesEl = document.getElementById('messages');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const roomTitle = document.getElementById('roomTitle');
  const nameModal = document.getElementById('nameModal');
  const nameInput = document.getElementById('nameInput');
  const nameSubmit = document.getElementById('nameSubmit');
  const publicRoomBtn = document.getElementById('publicRoomBtn');
  const createRoomBtn = document.getElementById('createRoomBtn');
  const joinRoomBtn = document.getElementById('joinRoomBtn');
  const joinedRoomsEl = document.getElementById('joinedRooms');

  let myID = window.currentUserID || localStorage.getItem("numericUserID");
  let username = "Anonymous";
  let currentRoom = "public";
  let currentListenerRef = null;
  let joinedRooms = new Set(['public']);

  // --- CORE FUNCTIONS ---

  function escapeHtml(s){ return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
  function isOwner(id) { return OWNER_IDS.includes(id); }

  function appendMessage(payload){
    const div = document.createElement('div');
    const isMe = payload.id === myID;
    const ownerClass = isOwner(payload.id) ? ' owner-msg' : '';
    div.className = 'msg' + (isMe ? ' own' : '') + ownerClass;
    
    const displayName = (payload.name && payload.id) ? `${payload.name} (${payload.id})` : (payload.name || `Anon (${payload.id})`);
    const ownerBadge = isOwner(payload.id) ? '<span class="owner-badge">V.I.P</span>' : '';
    const nameClass = isOwner(payload.id) ? 'msg-name owner' : 'msg-name';
    
    div.innerHTML = `<div class="${nameClass}">${escapeHtml(displayName)} ${ownerBadge}</div>
                     <div class="msg-bubble">${escapeHtml(payload.text)}</div>`;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function loadMessages(room){
    if(currentListenerRef) off(currentListenerRef);
    messagesEl.innerHTML = `<div style="text-align:center;color:#444;font-family:'Syncopate';font-size:8px;margin-bottom:10px;">ENCRYPTED_CHANNEL: ${room.toUpperCase()}</div>`;
    
    const messagesRef = ref(db, "messages/" + room);
    currentListenerRef = messagesRef;
    const limitedQuery = query(messagesRef, limitToLast(100));
    onChildAdded(limitedQuery, snap => appendMessage(snap.val()));
  }

  function switchRoom(room){
    currentRoom = room;
    roomTitle.innerText = room === 'public' ? 'GLOBAL_FEED' : room.toUpperCase();
    loadMessages(currentRoom);
    
    // Update active states in UI
    document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
    if(room === 'public') {
      publicRoomBtn.classList.add('active');
    } else {
      Array.from(joinedRoomsEl.children).forEach(el => {
        if(el.innerText.includes(room.toUpperCase())) el.classList.add('active');
      });
    }
  }

  function refreshJoinedRoomsUI(){
    joinedRoomsEl.innerHTML = '';
    joinedRooms.forEach(room => {
      if(room === 'public') return;
      const div = document.createElement('div');
      div.className = 'sidebar-item';
      div.innerText = `üì° ${room.toUpperCase()}`;
      div.onclick = () => switchRoom(room);
      joinedRoomsEl.appendChild(div);
    });
  }

  // --- EVENT LISTENERS ---

  sendBtn.onclick = () => {
    const txt = msgInput.value.trim();
    if(!txt) return;
    push(ref(db, "messages/" + currentRoom), {
      name: username,
      id: myID,
      text: txt,
      timestamp: Date.now()
    });
    msgInput.value = '';
  };

  msgInput.onkeypress = (e) => { if(e.key === 'Enter') sendBtn.click(); };

  nameSubmit.onclick = () => {
    username = nameInput.value.trim() || "Anonymous";
    nameModal.style.display = 'none';
    loadMessages(currentRoom);
  };

  publicRoomBtn.onclick = () => switchRoom('public');

  createRoomBtn.onclick = () => {
    const room = prompt("ENTER_NEW_CHANNEL_ID:")?.trim().toLowerCase();
    if(room && !joinedRooms.has(room)){
      joinedRooms.add(room);
      refreshJoinedRoomsUI();
      switchRoom(room);
    }
  };

  joinRoomBtn.onclick = () => {
    const room = prompt("ENTER_TARGET_FREQUENCY:")?.trim().toLowerCase();
    if(room && !joinedRooms.has(room)){
      joinedRooms.add(room);
      refreshJoinedRoomsUI();
      switchRoom(room);
    }
  };
</script>
</body>
</html>
