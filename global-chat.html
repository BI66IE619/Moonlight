<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Moonlight | Global Chat</title>
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />
    
    <style>
        :root {
            --bg: #000;
            --card: rgba(0, 0, 0, 0.7);
            --border: rgba(255, 255, 255, 0.2);
            --accent: #ffffff;
            --fg: #f5f5f5;
            --muted: #666;
            --success: #00ff00;
            --warning: #ffcc00;
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg);
            color: var(--fg);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Starfield Canvas Background */
        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* Tactical Header */
        header {
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(15px);
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        header h1 { 
            font-family: 'Syncopate', sans-serif;
            font-size: 0.9rem; 
            font-weight: 700; 
            letter-spacing: 3px; 
            cursor: pointer;
        }

        .header-tag {
            font-size: 0.6rem;
            background: rgba(255,255,255,0.1);
            padding: 2px 8px;
            border: 1px solid var(--border);
            color: var(--muted);
            margin-left: 12px;
            vertical-align: middle;
        }

        .status-dot {
            display: inline-block;
            width: 6px; height: 6px;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 0 8px currentColor;
        }

        main {
            display: flex;
            flex: 1;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 1.5rem;
            gap: 1.5rem;
            overflow: hidden;
        }

        /* Sidebar Styling */
        .sidebar { width: 280px; display: flex; flex-direction: column; gap: 1rem; }
        
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 1.2rem;
            backdrop-filter: blur(5px);
        }

        .card-label {
            font-family: 'Syncopate', sans-serif;
            font-size: 0.55rem;
            letter-spacing: 0.2em;
            color: var(--muted);
            margin-bottom: 0.5rem;
        }

        .card-value { font-size: 1.1rem; font-weight: 700; color: var(--accent); }
        .card-timer { font-size: 0.7rem; color: var(--success); margin-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; }

        /* Chat Window with Box Outline */
        .chat-view {
            flex: 1;
            background: var(--card);
            border: 1px solid #fff; /* Moonlight Tactical Border */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            background: rgba(255,255,255,0.02);
        }

        .msg-wrap { display: flex; width: 100%; animation: fade-in 0.3s ease-out; }
        .msg-wrap-own { justify-content: flex-end; }
        .msg-wrap-other { justify-content: flex-start; }

        @keyframes fade-in { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

        .msg {
            max-width: 80%;
            padding: 0.8rem 1.2rem;
            font-size: 0.85rem;
            line-height: 1.5;
            border: 1px solid var(--border);
        }

        .msg-own { background: #fff; color: #000; border: 1px solid #fff; }
        .msg-other { background: rgba(255,255,255,0.05); color: #fff; }

        .msg-meta {
            display: block;
            font-family: 'Syncopate', sans-serif;
            font-size: 0.5rem;
            font-weight: 700;
            margin-bottom: 6px;
            letter-spacing: 1px;
            opacity: 0.6;
        }

        /* Input Bar */
        .input-bar {
            padding: 1rem;
            border-top: 1px solid var(--border);
            background: rgba(0,0,0,0.8);
            display: flex;
            gap: 0.8rem;
        }

        #msg-input {
            flex: 1;
            padding: 0.8rem 1.2rem;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            outline: none;
            transition: border 0.3s;
        }

        #msg-input:focus { border-color: #fff; }

        .btn {
            background: #fff;
            color: #000;
            border: none;
            padding: 0 1.5rem;
            font-family: 'Syncopate', sans-serif;
            font-weight: 700;
            font-size: 0.65rem;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover { background: #ccc; }

        /* Nickname Overlay */
        #nick-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(15px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nick-box {
            background: #000;
            border: 1px solid #fff;
            padding: 4rem;
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        #nick-field {
            width: 100%;
            padding: 1rem;
            margin: 2rem 0 1rem;
            background: transparent;
            border: 1px solid var(--border);
            color: #fff;
            text-align: center;
            font-family: 'Syncopate', sans-serif;
            font-size: 1rem;
            outline: none;
        }
        #nick-field:focus { border-color: #fff; }
    </style>
</head>
<body>
    <canvas id="starfield"></canvas>

    <div id="nick-overlay">
        <div class="nick-box">
            <div style="font-family:'Syncopate'; font-size:0.6rem; letter-spacing:0.4em; color:var(--muted); margin-bottom:1rem;">
                NEURAL_LINK // GLOBAL_COMMS
            </div>
            <h1 style="font-family:'Syncopate'; font-size:1.8rem; font-weight:700; letter-spacing:4px;">
                MOON_CHAT
            </h1>
            <p id="modal-desc" style="color:var(--muted); font-size:0.7rem; margin-top:1rem; text-transform:uppercase;">
                establishing encrypted connection...
            </p>
            <div id="nick-ui" style="display:none;">
                <input type="text" id="nick-field" placeholder="IDENTIFIER" maxlength="12" />
                <button id="nick-submit" class="btn" style="width:100%; padding:1rem;">
                    AUTHORIZE_SESSION
                </button>
            </div>
        </div>
    </div>

    <header>
        <div style="display:flex; align-items:center;">
            <h1 onclick="window.location.href='main.html'">M // BACK</h1>
            <span class="header-tag">COMMS_V2.0</span>
        </div>
        <div style="display:flex; align-items:center; font-size:0.7rem; color:var(--muted); text-transform:uppercase; letter-spacing:1px;">
            <span id="status-dot" class="status-dot" style="background:var(--warning);"></span>
            <span id="status">OFFLINE</span>
        </div>
    </header>

    <main>
        <aside class="sidebar">
            <div class="card">
                <div class="card-label">CURRENT_IDENTIFIER</div>
                <div class="card-value" id="display-nick">—</div>
                <div class="card-timer" id="timer">⏱ --:--</div>
            </div>
            <div class="card" style="flex:1; overflow:hidden; display:flex; flex-direction:column;">
                <div class="card-label">ACTIVE_NODES // <span id="user-count">0</span></div>
                <div id="users-list" style="margin-top:0.75rem; overflow-y:auto; flex:1;"></div>
            </div>
        </aside>

        <section class="chat-view">
            <div id="messages"></div>
            <div class="input-bar">
                <input id="msg-input" type="text" placeholder="AWAITING LINK..." disabled autocomplete="off" />
                <button id="send-btn" class="btn" disabled>SEND</button>
            </div>
        </section>
    </main>

    <script type="module">
        // --- STARFIELD LOGIC ---
        const canvas = document.getElementById('starfield');
        const ctx = canvas.getContext('2d');
        let stars = [];
        function initStars() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            stars = [];
            for (let i = 0; i < 200; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 1.5,
                    speed: Math.random() * 0.05
                });
            }
        }
        function drawStars() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            stars.forEach(star => {
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
                star.y -= star.speed;
                if (star.y < 0) star.y = canvas.height;
            });
            requestAnimationFrame(drawStars);
        }
        window.addEventListener('resize', initStars);
        initStars();
        drawStars();

        // --- FIREBASE LOGIC ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getDatabase, ref, push, onValue, set, serverTimestamp, onDisconnect, query, limitToLast } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1DHChyFJ3lW-72DxCPemJ_aWIc0hWvDg",
            authDomain: "chat-da522.firebaseapp.com",
            databaseURL: "https://chat-da522-default-rtdb.firebaseio.com",
            projectId: "chat-da522",
            storageBucket: "chat-da522.firebasestorage.app",
            messagingSenderId: "1042912372756",
            appId: "1:1042912372756:web:e8dc76474f684e3799df01"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Censorship list
        const encodedBadWords = new Set(['ZnVjaw==','ZnVja2luZw==','ZnVja2Vk','ZnVja2Vy','bW90aGVyZnVja2Vy','bWZlcg==','cGh1Y2s=','ZnVr','cGh1aw==','ZnVjYw==','c2hpdA==','c2hpdHM=','cGlzcw==','YXNzaG9sZQ==','YXNz','YTVz','Yml0Y2g=','Y3VudA==','ZGljaw==','Y29jaw==','cHVzc3k=','bmlnZ2Vy','bmlnZ2E=','bjFnZ2Vy','bjFnZ2E=','bmln','ZmFnZ290','ZmFn','dHJhbm55','cmV0YXJk','cmV0YXJkZWQ=']);
        const decodedBadWords = [...encodedBadWords].map(e => { try { return atob(e) } catch { return e } });

        function censorText(text) {
            if (!text) return "";
            let result = text;
            decodedBadWords.forEach(word => {
                if (!word || word.length < 2) return;
                const escaped = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                result = result.replace(new RegExp(escaped, 'gi'), m => '*'.repeat(m.length));
            });
            return result;
        }

        let currentUser = null;
        let userNick = null;
        let sessionExpiry = 0;

        async function establishSession() {
            const val = document.getElementById('nick-field').value.trim().replace(/\s+/g, '').slice(0, 12);
            if (val.length < 2) return alert('ID Too Short');
            userNick = censorText(val);
            sessionExpiry = Date.now() + (10 * 60 * 1000);
            const userRef = ref(db, `users/${currentUser.uid}`);
            await set(userRef, { nick: userNick, online: true, expiry: sessionExpiry });
            onDisconnect(userRef).remove();
            document.getElementById('display-nick').textContent = userNick;
            document.getElementById('nick-overlay').style.display = 'none';
            document.getElementById('msg-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            document.getElementById('msg-input').placeholder = 'TRANSMIT MESSAGE...';
        }

        async function sendMessage() {
            const inp = document.getElementById('msg-input');
            const text = inp.value.trim();
            if (!text || !userNick) return;
            const censored = censorText(text);
            await push(ref(db, 'chat'), { text: btoa(censored), time: serverTimestamp(), uid: currentUser.uid, nick: userNick });
            inp.value = '';
        }

        onAuthStateChanged(auth, user => {
            if (!user) { signInAnonymously(auth); return }
            currentUser = user;
            document.getElementById('nick-ui').style.display = 'block';
            document.getElementById('modal-desc').textContent = 'AWAITING IDENTIFIER';
            document.getElementById('status').textContent = 'CONNECTED';
            document.getElementById('status-dot').style.background = 'var(--success)';
        });

        onValue(query(ref(db, 'chat'), limitToLast(50)), snap => {
            const msgBox = document.getElementById('messages');
            msgBox.innerHTML = '';
            snap.forEach(child => {
                const m = child.val();
                const wrap = document.createElement('div');
                const isOwn = (currentUser && m.uid === currentUser.uid);
                wrap.className = `msg-wrap ${isOwn ? 'msg-wrap-own' : 'msg-wrap-other'}`;
                const clean = censorText(atob(m.text));
                wrap.innerHTML = `<div class="msg ${isOwn ? 'msg-own' : 'msg-other'}"><span class="msg-meta">${m.nick}</span>${clean}</div>`;
                msgBox.appendChild(wrap);
            });
            msgBox.scrollTop = msgBox.scrollHeight;
        });

        onValue(ref(db, 'users'), snap => {
            const list = document.getElementById('users-list');
            list.innerHTML = '';
            let count = 0;
            snap.forEach(child => {
                const u = child.val();
                if (u.online && u.expiry > Date.now()) {
                    count++;
                    const el = document.createElement('div');
                    el.style = "display:flex; align-items:center; gap:8px; font-size:0.75rem; color:var(--muted); padding:4px 0;";
                    el.innerHTML = `<span style="width:6px; height:6px; border-radius:50%; background:var(--success)"></span>${u.nick}`;
                    list.appendChild(el);
                }
            });
            document.getElementById('user-count').textContent = count;
        });

        setInterval(() => {
            if (sessionExpiry > 0) {
                const rem = Math.max(0, sessionExpiry - Date.now());
                const m = Math.floor(rem / 60000), s = Math.floor((rem % 60000) / 1000);
                document.getElementById('timer').textContent = `⏱ ${m}m ${s}s`;
                if (rem <= 0) location.reload();
            }
        }, 1000);

        document.getElementById('nick-submit').onclick = establishSession;
        document.getElementById('send-btn').onclick = sendMessage;
        document.getElementById('msg-input').onkeypress = e => { if (e.key === 'Enter') sendMessage() };
        document.getElementById('nick-field').onkeypress = e => { if (e.key === 'Enter') establishSession() };
    </script>
</body>
</html>
